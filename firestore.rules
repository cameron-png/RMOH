
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin
    function isAdmin(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.isAdmin == true;
    }
    
    // By default, deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // /users/{userId}
    // Authenticated users can manage their own profile.
    // Admins can manage any profile.
    // The public can READ any user profile to see realtor info on the visitor page.
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth.uid == userId || isAdmin(request.auth.uid);
    }
    
    // /openHouses/{houseId}
    // Authenticated users can manage their own open houses.
    // Admins can manage any open house.
    // The public can READ any open house document to find the active one for a realtor.
    match /openHouses/{houseId} {
        allow read: if true;
        allow write: if request.auth.uid == resource.data.userId || isAdmin(request.auth.uid);
    }
    
    // /feedbackForms/{formId}
    // Authenticated users can manage their own forms and read global forms.
    // Admins can manage any form.
    // The public can READ any form document, as it's needed for the visitor page.
    match /feedbackForms/{formId} {
        allow read: if true;
        allow write: if (resource.data.type == 'custom' && request.auth.uid == resource.data.userId) || isAdmin(request.auth.uid);
    }

    // /leads/{leadId}
    // The public can CREATE leads.
    // Authenticated users can manage their own leads.
    // Admins can manage any lead.
    match /leads/{leadId} {
      allow create: if true;
      allow read, update, delete: if request.auth.uid == resource.data.userId || isAdmin(request.auth.uid);
    }

    // /feedbackSubmissions/{submissionId}
    // The public can CREATE feedback.
    // Authenticated users can read their own feedback.
    // Admins can read any feedback.
    match /feedbackSubmissions/{submissionId} {
      allow create: if true;
      allow read: if request.auth.uid == resource.data.userId || isAdmin(request.auth.uid);
    }
    
    // /gifts/{giftId}
    // Authenticated users can manage their own gifts.
    // Admins can manage any gift.
    match /gifts/{giftId} {
      allow read, write: if request.auth.uid == resource.data.userId || isAdmin(request.auth.uid);
    }
    
    // /settings/{docId}
    // Authenticated users (including admins) can read the appDefaults.
    // Admins can write to the appDefaults.
    match /settings/appDefaults {
      allow get: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }
  }
}
